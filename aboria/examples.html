<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Examples</title>
<link rel="stylesheet" href="../css/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="../index.html" title="Aboria 0.5">
<link rel="up" href="../index.html" title="Aboria 0.5">
<link rel="prev" href="symbolic_expressions.html" title="Symbolic Expressions">
<link rel="next" href="benchmarks.html" title="Benchmarks">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
    },
  TeX: { 
    extensions: ["AMSmath.js", "AMSsymbols.js"] 
    }
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48149829-4', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="Aboria" width="200" height="62" src="../images/aboria2.jpg"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="symbolic_expressions.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="benchmarks.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="aboria.examples"></a><a class="link" href="examples.html" title="Examples">Examples</a>
</h2></div></div></div>
<div class="toc"><dl class="toc">
<dt><span class="section"><a href="examples.html#aboria.examples.molecular_dynamics_linear_spring">Molecular
      Dynamics (Linear Spring) (MD)</a></span></dt>
<dt><span class="section"><a href="examples.html#aboria.examples.brownian_dynamics_bd">Brownian Dynamics
      (BD)</a></span></dt>
<dt><span class="section"><a href="examples.html#aboria.examples.discrete_element_model_dem">Discrete
      Element Model (DEM)</a></span></dt>
<dt><span class="section"><a href="examples.html#aboria.examples.smoothed_particle_hydrodynamics_">Smoothed
      Particle Hydrodynamics (SPH)</a></span></dt>
<dt><span class="section"><a href="examples.html#aboria.examples.radial_basis_function_rbf_interp">Radial
      Basis Function (RBF) Interpolation</a></span></dt>
<dt><span class="section"><a href="examples.html#aboria.examples.kansa_method_for_pdes">Kansa Method for
      PDEs</a></span></dt>
</dl></div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="aboria.examples.molecular_dynamics_linear_spring"></a><a class="link" href="examples.html#aboria.examples.molecular_dynamics_linear_spring" title="Molecular Dynamics (Linear Spring) (MD)">Molecular
      Dynamics (Linear Spring) (MD)</a>
</h3></div></div></div>
<p>
        Simple Molecular Dynamics of $N$ particles interacting via a linear spring
        potential.
      </p>
<p>
        This example creates $N$ particles within a two-dimensional square domain,
        with periodic boundary conditions.
      </p>
<p>
        There is a linear spring force $\mathbf{f}_{ij}$ between particles $i$ and
        $j$ with a rest separation of $r$ (constant for all particles), and a cutoff
        at $r$. That is, if $\mathbf{r}_i$ is the position of particle $i$ and $\mathbf{dx}_{ij}=\mathbf{r}_j-\mathbf{r}_j$,
        then
      </p>
<p>
        $$ \mathbf{f}_{ij} = \begin{cases} \frac{r-|\mathbf{dx}_{ij}|}{|\mathbf{dx}_{ij}|}\mathbf{dx}_{ij},
        &amp; \text{for } |\mathbf{dx}_{ij}|&lt;r \\ 0 &amp; \text{otherwise}. \end{cases}
        $$
      </p>
<p>
        We wish to use a leap frog integrator to evolve positions $\mathbf{r}_i$
        using velocities $\mathbf{v}_i$ and accelerations $\mathbf{a}_i = \sum_j
        \mathbf{f}_{ij}$. This gives the following update equations for each timestep
        $n$
      </p>
<p>
        \begin{align*} \mathbf{v}^{n+1}_i &amp;= \mathbf{v}^n_i + \frac{dt}{m_i}
        \sum_j \mathbf{f}^n_{ij} \\ \mathbf{r}^{n+1}_i &amp;= \mathbf{r}^n_i + dt,
        \mathbf{v}^{n+1}_i. \end{align*}
      </p>
<p>
        We implement this in Aboria using the code given below. Firstly we create
        the particle set data structure and add particles, ensuring that we have
        an initial condition where all the spring forces are $\mathbf{f}_{ij}=0$.
        Then we start the timestep loop, using our update equations given above.
      </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">random</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"Aboria.h"</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">Aboria</span><span class="special">;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">math</span><span class="special">/</span><span class="identifier">constants</span><span class="special">/</span><span class="identifier">constants</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">math</span><span class="special">.</span><span class="identifier">h</span><span class="special">&gt;</span>

    <span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span> <span class="special">{</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">PI</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">math</span><span class="special">::</span><span class="identifier">constants</span><span class="special">::</span><span class="identifier">pi</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;();</span>

    <span class="comment">/*
     * Create a 2d particle container with one additional variable
     * "velocity", represented by a 2d double vector
     */</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">velocity</span><span class="special">,</span> <span class="identifier">vdouble2</span><span class="special">,</span> <span class="string">"velocity"</span><span class="special">)</span>
            <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">velocity</span><span class="special">&gt;,</span><span class="number">2</span><span class="special">&gt;</span> <span class="identifier">container_type</span><span class="special">;</span>

    <span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="identifier">container_type</span><span class="special">::</span><span class="identifier">position</span> <span class="identifier">position</span><span class="special">;</span>
    <span class="identifier">container_type</span> <span class="identifier">particles</span><span class="special">;</span>

    <span class="comment">/*
     * set parameters for the MD simulation
     */</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">timesteps</span> <span class="special">=</span> <span class="number">3000</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">nout</span> <span class="special">=</span> <span class="number">200</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">timesteps_per_out</span> <span class="special">=</span> <span class="identifier">timesteps</span> <span class="special">/</span> <span class="identifier">nout</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">L</span> <span class="special">=</span> <span class="number">31.0</span> <span class="special">/</span> <span class="number">1000.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">N</span> <span class="special">=</span> <span class="number">30</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">diameter</span> <span class="special">=</span> <span class="number">0.0022</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">k</span> <span class="special">=</span> <span class="number">1.0e01</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dens</span> <span class="special">=</span> <span class="number">1160.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">mass</span> <span class="special">=</span> <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="number">6.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">PI</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="number">0.5</span> <span class="special">*</span> <span class="identifier">diameter</span><span class="special">,</span> <span class="number">3</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dens</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">reduced_mass</span> <span class="special">=</span> <span class="number">0.5</span> <span class="special">*</span> <span class="identifier">mass</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dt</span> <span class="special">=</span> <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="number">50.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">PI</span> <span class="special">/</span> <span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">k</span> <span class="special">/</span> <span class="identifier">reduced_mass</span><span class="special">);</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">v0</span> <span class="special">=</span> <span class="identifier">L</span> <span class="special">/</span> <span class="special">(</span><span class="identifier">timesteps</span> <span class="special">*</span> <span class="identifier">dt</span><span class="special">);</span>

    <span class="comment">/*
     * initiate neighbour search on a periodic 2d domain of side length L
     * set average number of particles per cell to 1
     */</span>
    <span class="identifier">particles</span><span class="special">.</span><span class="identifier">init_neighbour_search</span><span class="special">(</span><span class="identifier">vdouble2</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">),</span> <span class="identifier">vdouble2</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">L</span><span class="special">),</span>
                                    <span class="identifier">vbool2</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="keyword">true</span><span class="special">));</span>

    <span class="comment">/*
     * create N particles, ensuring that they do not overlap, according
     * to the set diameter. set the initial velocity in a random direction
     */</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">uniform_real_distribution</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;</span> <span class="identifier">uni</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">1</span><span class="special">);</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">N</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">bool</span> <span class="identifier">free_position</span> <span class="special">=</span> <span class="keyword">false</span><span class="special">;</span>

      <span class="comment">/*
       * create new particle
       */</span>
      <span class="keyword">typename</span> <span class="identifier">container_type</span><span class="special">::</span><span class="identifier">value_type</span> <span class="identifier">p</span><span class="special">;</span>

      <span class="comment">/*
       * set a random direction, and initialise velocity
       */</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">theta</span> <span class="special">=</span> <span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">*</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">PI</span><span class="special">;</span>
      <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">velocity</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">v0</span> <span class="special">*</span> <span class="identifier">vdouble2</span><span class="special">(</span><span class="identifier">cos</span><span class="special">(</span><span class="identifier">theta</span><span class="special">),</span> <span class="identifier">sin</span><span class="special">(</span><span class="identifier">theta</span><span class="special">));</span>

      <span class="comment">/*
       * randomly choose positions within the domain until one is
       * found with no other particles within a range equal to diameter
       */</span>
      <span class="keyword">while</span> <span class="special">(</span><span class="identifier">free_position</span> <span class="special">==</span> <span class="keyword">false</span><span class="special">)</span> <span class="special">{</span>
        <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">vdouble2</span><span class="special">(</span><span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">L</span><span class="special">,</span> <span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">L</span><span class="special">);</span>
        <span class="identifier">free_position</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>

        <span class="comment">/*
         * loop over all neighbouring particles within a euclidean distance
         * of size "diameter"
         */</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">tpl</span> <span class="special">:</span> <span class="identifier">euclidean_search</span><span class="special">(</span><span class="identifier">particles</span><span class="special">.</span><span class="identifier">get_query</span><span class="special">(),</span>
                                         <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">),</span> <span class="identifier">diameter</span><span class="special">))</span> <span class="special">{</span>

          <span class="comment">/*
           * tpl variable is a tuple containing:
           *  (0) -&gt; neighbouring particle value_type
           *  (1) -&gt; relative position of neighbouring particle
           *         from query point
           *  e.g.
           *
           *  const vdouble2&amp; dx = std::get&lt;1&gt;(tpl);
           *  const typename container_type::value_type&amp; j = std::get&lt;0&gt;(tpl);
           */</span>
          <span class="identifier">free_position</span> <span class="special">=</span> <span class="keyword">false</span><span class="special">;</span>
          <span class="keyword">break</span><span class="special">;</span>
        <span class="special">}</span>
      <span class="special">}</span>
      <span class="identifier">particles</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">/*
     * create symbols and labels in order to use the expression API
     */</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;</span> <span class="identifier">p</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">velocity</span><span class="special">&gt;</span> <span class="identifier">v</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">id</span><span class="special">&gt;</span> <span class="identifier">id_</span><span class="special">;</span>
    <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">0</span><span class="special">,</span> <span class="identifier">container_type</span><span class="special">&gt;</span> <span class="identifier">a</span><span class="special">(</span><span class="identifier">particles</span><span class="special">);</span>
    <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">1</span><span class="special">,</span> <span class="identifier">container_type</span><span class="special">&gt;</span> <span class="identifier">b</span><span class="special">(</span><span class="identifier">particles</span><span class="special">);</span>

    <span class="comment">/*
     * dx is a symbol representing the difference in positions of
     * particle a and b.
     */</span>
    <span class="keyword">auto</span> <span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">create_dx</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span> <span class="identifier">b</span><span class="special">);</span>

    <span class="comment">/*
     * sum is a symbolic function that sums a sequence of 2d vectors
     */</span>
    <span class="identifier">AccumulateWithinDistance</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">plus</span><span class="special">&lt;</span><span class="identifier">vdouble2</span><span class="special">&gt;&gt;</span> <span class="identifier">sum</span><span class="special">(</span><span class="identifier">diameter</span><span class="special">);</span>

    <span class="comment">/*
     * perform MD timestepping
     */</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">io</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">io</span> <span class="special">&lt;</span> <span class="identifier">nout</span><span class="special">;</span> <span class="special">++</span><span class="identifier">io</span><span class="special">)</span> <span class="special">{</span>

      <span class="comment">/*
       * on every i/o step write particle container to a vtk
       * unstructured grid file
       */</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">flush</span><span class="special">;</span>
<span class="preprocessor">#ifdef</span> <span class="identifier">HAVE_VTK</span>
      <span class="identifier">vtkWriteGrid</span><span class="special">(</span><span class="string">"particles"</span><span class="special">,</span> <span class="identifier">io</span><span class="special">,</span> <span class="identifier">particles</span><span class="special">.</span><span class="identifier">get_grid</span><span class="special">(</span><span class="keyword">true</span><span class="special">));</span>
<span class="preprocessor">#endif</span>
      <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">timesteps_per_out</span><span class="special">;</span> <span class="identifier">i</span><span class="special">++)</span> <span class="special">{</span>
        <span class="comment">/*
         * leap frog integrator
         */</span>
        <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">dt</span> <span class="special">*</span> <span class="special">(</span>
                         <span class="comment">// spring force between particles</span>
                         <span class="identifier">sum</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">id_</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">!=</span> <span class="identifier">id_</span><span class="special">[</span><span class="identifier">b</span><span class="special">],</span>
                                        <span class="special">-</span><span class="identifier">k</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">diameter</span> <span class="special">/</span> <span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">-</span> <span class="number">1</span><span class="special">),</span> <span class="number">0.0</span><span class="special">)</span> <span class="special">*</span>
                                    <span class="identifier">dx</span><span class="special">)</span> <span class="special">/</span>
                         <span class="identifier">mass</span><span class="special">);</span>
        <span class="identifier">p</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">dt</span> <span class="special">*</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>
      <span class="special">}</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
  <span class="special">}</span>
</pre>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="aboria.examples.brownian_dynamics_bd"></a><a class="link" href="examples.html#aboria.examples.brownian_dynamics_bd" title="Brownian Dynamics (BD)">Brownian Dynamics
      (BD)</a>
</h3></div></div></div>
<p>
        This example creates two particle sets, the first representing a set of point
        particles undergoing brownian motion, the second representing a set of spheres
        with a given radius, different for each sphere.
      </p>
<p>
        The point particles diffuse around the three-dimensional, periodic domain,
        and reflect off the spheres whenever they encounter them.
      </p>
<p>
        Let indicies $i$ and $j$ refer to a pair of point particles, and $a$ and
        $b$ refer to a pair of spheres. Let $\mathbf{p}_i$ be the position of particle
        $i$, and let $\mathbf{dx}_{ij}$ refer to the shortest difference between
        the positions of particles $i$ and $j$. Let $r_b$ be the radius of sphere
        $b$. Then the update equations used to evolve the system are given by
      </p>
<p>
        $$ \mathbf{p}_i = \mathbf{p}_i + \sqrt{2\, D\, dt}\, \mathbf{N} + \sum_b
        \begin{cases} -2\left(\frac{r_b}{||\mathbf{dx}_{ib}||} - 1\right) \mathbf{dx}_{ib},
        &amp; \text{for } ||\mathbf{dx}_{ib}||&lt;r_b \\ 0 &amp; \text{otherwise}.
        \end{cases} $$
      </p>
<p>
        where $D$ is the diffusion constant, $dt$ is the timestep and $\mathbf{N}$
        is a three-dimensional vector containing random samples from a normal distribution
      </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">random</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="string">"Aboria.h"</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">Aboria</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span> <span class="special">{</span>
        <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">radius</span><span class="special">,</span><span class="keyword">double</span><span class="special">,</span><span class="string">"radius"</span><span class="special">)</span>

        <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;,</span><span class="number">3</span><span class="special">,</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&gt;</span> <span class="identifier">spheres_type</span><span class="special">;</span>
        <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span><span class="number">3</span><span class="special">,</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&gt;</span> <span class="identifier">points_type</span><span class="special">;</span>

        <span class="keyword">typedef</span> <span class="identifier">position_d</span><span class="special">&lt;</span><span class="number">3</span><span class="special">&gt;</span> <span class="identifier">position</span><span class="special">;</span>
        <span class="identifier">spheres_type</span> <span class="identifier">spheres</span><span class="special">;</span>

        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">L</span> <span class="special">=</span> <span class="number">10.0</span><span class="special">;</span>
        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">D</span> <span class="special">=</span> <span class="number">1.0</span><span class="special">;</span>
        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dt</span> <span class="special">=</span> <span class="number">0.01</span><span class="special">;</span>
        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">timesteps</span> <span class="special">=</span> <span class="number">1000</span><span class="special">;</span>

        <span class="identifier">spheres</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span><span class="number">0</span><span class="special">,</span><span class="number">0</span><span class="special">));</span>
        <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">0</span><span class="special">])</span> <span class="special">=</span> <span class="number">1.0</span><span class="special">;</span>
        <span class="identifier">spheres</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="number">5</span><span class="special">,</span><span class="number">0</span><span class="special">,</span><span class="number">0</span><span class="special">));</span>
        <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">1</span><span class="special">])</span> <span class="special">=</span> <span class="number">2.0</span><span class="special">;</span>
        <span class="identifier">spheres</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,-</span><span class="number">5</span><span class="special">,</span><span class="number">0</span><span class="special">));</span>
        <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">2</span><span class="special">])</span> <span class="special">=</span> <span class="number">1.5</span><span class="special">;</span>
        <span class="identifier">spheres</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span><span class="number">0</span><span class="special">,</span><span class="number">5</span><span class="special">));</span>
        <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">3</span><span class="special">])</span> <span class="special">=</span> <span class="number">1.0</span><span class="special">;</span>

        <span class="identifier">points_type</span> <span class="identifier">points</span><span class="special">;</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">uniform_real_distribution</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;</span> <span class="identifier">uni</span><span class="special">(-</span><span class="identifier">L</span><span class="special">+</span><span class="identifier">L</span><span class="special">/</span><span class="number">5</span><span class="special">,</span><span class="identifier">L</span><span class="special">-</span><span class="identifier">L</span><span class="special">/</span><span class="number">5</span><span class="special">);</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">default_random_engine</span> <span class="identifier">generator</span><span class="special">;</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="number">1000</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
            <span class="identifier">points</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">),</span><span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">),</span><span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)));</span>
        <span class="special">}</span>


        <span class="identifier">points</span><span class="special">.</span><span class="identifier">init_neighbour_search</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(-</span><span class="identifier">L</span><span class="special">,-</span><span class="identifier">L</span><span class="special">,-</span><span class="identifier">L</span><span class="special">),</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span><span class="identifier">L</span><span class="special">,</span><span class="identifier">L</span><span class="special">),</span><span class="identifier">vbool3</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span><span class="keyword">true</span><span class="special">,</span><span class="keyword">true</span><span class="special">));</span>
        <span class="identifier">spheres</span><span class="special">.</span><span class="identifier">init_neighbour_search</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(-</span><span class="identifier">L</span><span class="special">,-</span><span class="identifier">L</span><span class="special">,-</span><span class="identifier">L</span><span class="special">),</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span><span class="identifier">L</span><span class="special">,</span><span class="identifier">L</span><span class="special">),</span><span class="identifier">vbool3</span><span class="special">(</span><span class="keyword">false</span><span class="special">,</span><span class="keyword">false</span><span class="special">,</span><span class="keyword">false</span><span class="special">));</span>

        <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;</span> <span class="identifier">p</span><span class="special">;</span>
        <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;</span> <span class="identifier">r</span><span class="special">;</span>
        <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">alive</span><span class="special">&gt;</span> <span class="identifier">alive_</span><span class="special">;</span>
        <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">0</span><span class="special">,</span><span class="identifier">spheres_type</span> <span class="special">&gt;</span> <span class="identifier">a</span><span class="special">(</span><span class="identifier">spheres</span><span class="special">);</span>
        <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">1</span><span class="special">,</span><span class="identifier">spheres_type</span> <span class="special">&gt;</span> <span class="identifier">b</span><span class="special">(</span><span class="identifier">spheres</span><span class="special">);</span>
        <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">0</span><span class="special">,</span><span class="identifier">points_type</span> <span class="special">&gt;</span> <span class="identifier">i</span><span class="special">(</span><span class="identifier">points</span><span class="special">);</span>
        <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">1</span><span class="special">,</span><span class="identifier">points_type</span> <span class="special">&gt;</span> <span class="identifier">j</span><span class="special">(</span><span class="identifier">points</span><span class="special">);</span>
        <span class="keyword">auto</span> <span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">create_dx</span><span class="special">(</span><span class="identifier">i</span><span class="special">,</span><span class="identifier">b</span><span class="special">);</span>
        <span class="identifier">Normal</span> <span class="identifier">N</span><span class="special">;</span>
        <span class="identifier">VectorSymbolic</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span><span class="number">3</span><span class="special">&gt;</span> <span class="identifier">vector</span><span class="special">;</span>
        <span class="identifier">AccumulateWithinDistance</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">bit_or</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">any</span><span class="special">(</span><span class="number">4</span><span class="special">);</span>
        <span class="identifier">AccumulateWithinDistance</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">plus</span><span class="special">&lt;</span><span class="identifier">vdouble3</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">sum</span><span class="special">(</span><span class="number">4</span><span class="special">);</span>

        <span class="keyword">int</span> <span class="identifier">count_before</span><span class="special">=</span><span class="number">0</span><span class="special">;</span>
        <span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="identifier">point</span><span class="special">:</span> <span class="identifier">points</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">((</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">point</span><span class="special">)-</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">0</span><span class="special">])).</span><span class="identifier">norm</span><span class="special">()</span> <span class="special">&lt;</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">0</span><span class="special">]))</span> <span class="special">{</span>
                <span class="identifier">count_before</span><span class="special">++;</span>
            <span class="special">}</span>
        <span class="special">}</span>

        <span class="comment">/*
         * Kill any points within spheres
         */</span>
        <span class="identifier">alive_</span><span class="special">[</span><span class="identifier">i</span><span class="special">]</span> <span class="special">=</span> <span class="special">!</span><span class="identifier">any</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">&lt;</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">b</span><span class="special">],</span><span class="keyword">true</span><span class="special">,</span><span class="keyword">false</span><span class="special">));</span>


        <span class="keyword">int</span> <span class="identifier">count_after</span><span class="special">=</span><span class="number">0</span><span class="special">;</span>
        <span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="identifier">point</span><span class="special">:</span> <span class="identifier">points</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">((</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">point</span><span class="special">)-</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">0</span><span class="special">])).</span><span class="identifier">norm</span><span class="special">()</span> <span class="special">&lt;</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">spheres</span><span class="special">[</span><span class="number">0</span><span class="special">]))</span> <span class="special">{</span>
                <span class="identifier">count_after</span><span class="special">++;</span>
            <span class="special">}</span>
        <span class="special">}</span>

        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="string">" found "</span><span class="special">&lt;&lt;</span><span class="identifier">count_before</span><span class="special">&lt;&lt;</span><span class="string">" before and "</span><span class="special">&lt;&lt;</span><span class="identifier">count_after</span><span class="special">&lt;&lt;</span><span class="string">" after"</span><span class="special">&lt;&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

        <span class="comment">/*
         * Diffusion step for points and reflect off spheres
         */</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">ts</span> <span class="special">=</span> <span class="number">1</span><span class="special">;</span> <span class="identifier">ts</span> <span class="special">&lt;</span> <span class="identifier">timesteps</span><span class="special">;</span> <span class="special">++</span><span class="identifier">ts</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ts</span><span class="special">%</span><span class="number">10</span><span class="special">==</span><span class="number">0</span><span class="special">)</span> <span class="special">{</span>

<span class="preprocessor">#ifdef</span> <span class="identifier">HAVE_VTK</span>
                <span class="identifier">vtkWriteGrid</span><span class="special">(</span><span class="string">"bd"</span><span class="special">,</span><span class="identifier">ts</span><span class="special">/</span><span class="number">10</span><span class="special">,</span><span class="identifier">points</span><span class="special">.</span><span class="identifier">get_grid</span><span class="special">(</span><span class="keyword">true</span><span class="special">));</span>
<span class="preprocessor">#endif</span>
                <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">flush</span><span class="special">;</span>
            <span class="special">}</span>
            <span class="identifier">p</span><span class="special">[</span><span class="identifier">i</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="number">2</span><span class="special">*</span><span class="identifier">D</span><span class="special">*</span><span class="identifier">dt</span><span class="special">)*</span><span class="identifier">vector</span><span class="special">(</span><span class="identifier">N</span><span class="special">[</span><span class="identifier">i</span><span class="special">],</span><span class="identifier">N</span><span class="special">[</span><span class="identifier">i</span><span class="special">],</span><span class="identifier">N</span><span class="special">[</span><span class="identifier">i</span><span class="special">]);</span>
            <span class="identifier">p</span><span class="special">[</span><span class="identifier">i</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">sum</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">&lt;</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">b</span><span class="special">]</span> <span class="special">&amp;&amp;</span> <span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">!=</span> <span class="number">0</span>
                                <span class="special">,-</span><span class="number">2</span><span class="special">*(</span><span class="identifier">r</span><span class="special">[</span><span class="identifier">b</span><span class="special">]/</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)-</span><span class="number">1</span><span class="special">)</span>
                                <span class="special">,</span><span class="number">0</span><span class="special">)*</span><span class="identifier">dx</span><span class="special">);</span>

        <span class="special">}</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="special">}</span>
</pre>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="aboria.examples.discrete_element_model_dem"></a><a class="link" href="examples.html#aboria.examples.discrete_element_model_dem" title="Discrete Element Model (DEM)">Discrete
      Element Model (DEM)</a>
</h3></div></div></div>
<p>
        An Discrete Element Model example, simulating a polydisperse set of spherical
        particles falling onto an surface.
      </p>
<p>
        We wish to describe a set of particles in 3D cuboid, which is periodic in
        the Cartesian $x$, and $y$ directions. There is a linear spring force $\mathbf{f}_{ij}$
        plus dissipation term between particles $i$ and $j$ with a rest separation
        at $s_i + s_j$ and a cutoff at $s_i + s_j$. That is, if $\mathbf{r}_i$ is
        the position of particle $i$ and $\mathbf{dx}_{ij}=\mathbf{r}_j-\mathbf{r}_j$,
        then
      </p>
<p>
        $$ \mathbf{f}_{ij} = \begin{cases} \frac{s_i+s_j-|\mathbf{dx}_{ij}|}{|\mathbf{dx}_{ij}|}\mathbf{dx}_{ij}
        + \gamma(\mathbf{v}_j-\mathbf{v}_i), &amp; \text{for } |\mathbf{dx}_{ij}|&lt;s_i+s_j
        \\ 0 &amp; \text{otherwise}. \end{cases} $$
      </p>
<p>
        We wish to use a leap frog integrator to evolve positions $\mathbf{r}_i$
        using velocities $\mathbf{v}_i$ and accelerations $\mathbf{a}_i = \frac{1}{m_i}
        \sum_j \mathbf{f}_{ij} - \mathbf{g}$. This gives the following update equations
        for each timestep $n$
      </p>
<p>
        \begin{align*} \mathbf{v}^{n+1}_i &amp;= \mathbf{v}^n_i + \frac{dt}{m_i}
        \sum_j \mathbf{f}^n_{ij} \\ \mathbf{r}^{n+1}_i &amp;= \mathbf{r}^n_i + dt,
        \mathbf{v}^{n+1}_i. \end{align*}
      </p>
<p>
        <span class="inlinemediaobject"><object type="image/svg+xml" data="../images/dem/domain.svg" width="209" height="256" align="middle"></object></span>
      </p>
<p>
        This figure above shows the simulation domain. As well as periodic in $x$,
        and $y$, we wish to add a soft surface at $z=0$ that also interacts with
        the particles using the same linear spring force. The domain is left open
        at $z=h$. We wish to initialise $N$ particles within this domain, and ensure
        that they are non-interacting at $t=0$.
      </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">random</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"Aboria.h"</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">Aboria</span><span class="special">;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">math</span><span class="special">/</span><span class="identifier">constants</span><span class="special">/</span><span class="identifier">constants</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

    <span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span> <span class="special">{</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">PI</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">math</span><span class="special">::</span><span class="identifier">constants</span><span class="special">::</span><span class="identifier">pi</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;();</span>

    <span class="comment">/*
     * create variable types
     */</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">radius</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"radius"</span><span class="special">)</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">mass</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"mass"</span><span class="special">)</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">velocity</span><span class="special">,</span> <span class="identifier">vdouble3</span><span class="special">,</span> <span class="string">"velocity"</span><span class="special">)</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">acceleration</span><span class="special">,</span> <span class="identifier">vdouble3</span><span class="special">,</span> <span class="string">"acceleration"</span><span class="special">)</span>

    <span class="comment">/*
     * create particle container
     */</span>
    <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">,</span> <span class="identifier">velocity</span><span class="special">,</span> <span class="identifier">acceleration</span><span class="special">,</span> <span class="identifier">mass</span><span class="special">&gt;&gt;</span>
        <span class="identifier">dem_type</span><span class="special">;</span>
    <span class="keyword">typedef</span> <span class="identifier">position_d</span><span class="special">&lt;</span><span class="number">3</span><span class="special">&gt;</span> <span class="identifier">position</span><span class="special">;</span>
    <span class="identifier">dem_type</span> <span class="identifier">dem</span><span class="special">;</span>

    <span class="comment">/*
     * simulation parameters
     */</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">timesteps</span> <span class="special">=</span> <span class="number">30000</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">nout</span> <span class="special">=</span> <span class="number">200</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">timesteps_per_out</span> <span class="special">=</span> <span class="identifier">timesteps</span> <span class="special">/</span> <span class="identifier">nout</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">L</span> <span class="special">=</span> <span class="number">31.0</span> <span class="special">/</span> <span class="number">1000.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">N</span> <span class="special">=</span> <span class="number">30</span><span class="special">;</span>

    <span class="comment">/*
     * dem parameters
     */</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_diameter</span> <span class="special">=</span> <span class="number">0.0022</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_gamma</span> <span class="special">=</span> <span class="number">0.0004</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_k</span> <span class="special">=</span> <span class="number">1.0e01</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_dens</span> <span class="special">=</span> <span class="number">1160.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_mass_min</span> <span class="special">=</span>
        <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="number">6.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">PI</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="number">0.5</span> <span class="special">*</span> <span class="identifier">dem_diameter</span><span class="special">,</span> <span class="number">3</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dem_dens</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_mass_max</span> <span class="special">=</span>
        <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="number">6.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">PI</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">dem_diameter</span><span class="special">,</span> <span class="number">3</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dem_dens</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dem_min_reduced_mass</span> <span class="special">=</span>
        <span class="identifier">dem_mass_min</span> <span class="special">*</span> <span class="identifier">dem_mass_max</span> <span class="special">/</span> <span class="special">(</span><span class="identifier">dem_mass_min</span> <span class="special">+</span> <span class="identifier">dem_mass_max</span><span class="special">);</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dt</span> <span class="special">=</span> <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="number">50.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">PI</span> <span class="special">/</span>
                      <span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">dem_k</span> <span class="special">/</span> <span class="identifier">dem_min_reduced_mass</span> <span class="special">-</span>
                           <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="number">0.5</span> <span class="special">*</span> <span class="identifier">dem_gamma</span> <span class="special">/</span> <span class="identifier">dem_min_reduced_mass</span><span class="special">,</span> <span class="number">2</span><span class="special">));</span>

    <span class="comment">/*
     * initialise neighbour search with 3d cuboid domain,
     * periodic in x and y, set cell size so that there is
     * an average of 2 particles within each cell
     */</span>
    <span class="identifier">dem</span><span class="special">.</span><span class="identifier">init_neighbour_search</span><span class="special">(</span><span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="special">-</span><span class="identifier">dem_diameter</span><span class="special">),</span>
                              <span class="identifier">vdouble3</span><span class="special">(</span><span class="identifier">L</span> <span class="special">/</span> <span class="number">3</span><span class="special">,</span> <span class="identifier">L</span> <span class="special">/</span> <span class="number">3</span><span class="special">,</span> <span class="identifier">L</span> <span class="special">+</span> <span class="identifier">dem_diameter</span><span class="special">),</span>
                              <span class="identifier">vbool3</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="keyword">true</span><span class="special">,</span> <span class="keyword">false</span><span class="special">),</span> <span class="number">2</span><span class="special">);</span>

    <span class="comment">/*
     * create N random, non-overlaping particles with
     * random radius between 0.5*dem_diameter and dem_diameter
     */</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">uniform_real_distribution</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;</span> <span class="identifier">uni</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">1</span><span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">default_random_engine</span> <span class="identifier">generator</span><span class="special">;</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">N</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">bool</span> <span class="identifier">free_position</span> <span class="special">=</span> <span class="keyword">false</span><span class="special">;</span>
      <span class="identifier">dem_type</span><span class="special">::</span><span class="identifier">value_type</span> <span class="identifier">p</span><span class="special">;</span>

      <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="number">0.25</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">+</span> <span class="number">1</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dem_diameter</span><span class="special">;</span>
      <span class="keyword">while</span> <span class="special">(</span><span class="identifier">free_position</span> <span class="special">==</span> <span class="keyword">false</span><span class="special">)</span> <span class="special">{</span>
        <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span>
            <span class="identifier">vdouble3</span><span class="special">(</span><span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">L</span> <span class="special">/</span> <span class="number">3</span><span class="special">,</span> <span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">L</span> <span class="special">/</span> <span class="number">3</span><span class="special">,</span>
                     <span class="identifier">uni</span><span class="special">(</span><span class="identifier">generator</span><span class="special">)</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">L</span> <span class="special">-</span> <span class="identifier">dem_diameter</span><span class="special">)</span> <span class="special">+</span> <span class="identifier">dem_diameter</span> <span class="special">/</span> <span class="number">2</span><span class="special">);</span>
        <span class="identifier">free_position</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>
        <span class="comment">/*
         * loop over all neighbouring particles within "dem_diameter" distance
         */</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">tpl</span> <span class="special">:</span> <span class="identifier">euclidean_search</span><span class="special">(</span><span class="identifier">dem</span><span class="special">.</span><span class="identifier">get_query</span><span class="special">(),</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">),</span>
                                         <span class="identifier">dem_diameter</span><span class="special">))</span> <span class="special">{</span>
          <span class="comment">/*
           * tpl variable is a tuple containing:
           *  (0) -&gt; neighbouring particle value_type
           *  (1) -&gt; relative position of neighbouring particle
           *         from query point
           */</span>
          <span class="keyword">const</span> <span class="identifier">vdouble3</span> <span class="special">&amp;</span><span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">get</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;(</span><span class="identifier">tpl</span><span class="special">);</span>
          <span class="keyword">const</span> <span class="identifier">dem_type</span><span class="special">::</span><span class="identifier">value_type</span> <span class="special">&amp;</span><span class="identifier">j</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">get</span><span class="special">&lt;</span><span class="number">0</span><span class="special">&gt;(</span><span class="identifier">tpl</span><span class="special">);</span>
          <span class="keyword">if</span> <span class="special">(</span><span class="identifier">dx</span><span class="special">.</span><span class="identifier">norm</span><span class="special">()</span> <span class="special">&lt;</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">j</span><span class="special">)</span> <span class="special">+</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">))</span> <span class="special">{</span>
            <span class="identifier">free_position</span> <span class="special">=</span> <span class="keyword">false</span><span class="special">;</span>
            <span class="keyword">break</span><span class="special">;</span>
          <span class="special">}</span>
        <span class="special">}</span>
      <span class="special">}</span>
      <span class="identifier">dem</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">/*
     * create symbols and labels in order to use the expression API
     */</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;</span> <span class="identifier">p</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">radius</span><span class="special">&gt;</span> <span class="identifier">r</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">mass</span><span class="special">&gt;</span> <span class="identifier">m</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">velocity</span><span class="special">&gt;</span> <span class="identifier">v</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">acceleration</span><span class="special">&gt;</span> <span class="identifier">dvdt</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">id</span><span class="special">&gt;</span> <span class="identifier">id_</span><span class="special">;</span>
    <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">0</span><span class="special">,</span> <span class="identifier">dem_type</span><span class="special">&gt;</span> <span class="identifier">a</span><span class="special">(</span><span class="identifier">dem</span><span class="special">);</span>
    <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">1</span><span class="special">,</span> <span class="identifier">dem_type</span><span class="special">&gt;</span> <span class="identifier">b</span><span class="special">(</span><span class="identifier">dem</span><span class="special">);</span>

    <span class="comment">/*
     * dx is a symbol representing the difference in positions of
     * particle a and b.
     */</span>
    <span class="keyword">auto</span> <span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">create_dx</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span> <span class="identifier">b</span><span class="special">);</span>

    <span class="comment">/*
     * sum is a symbolic function that sums a sequence of 3d vectors
     * over neighbouring particles within "dem_diameter"
     */</span>
    <span class="identifier">AccumulateWithinDistance</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">plus</span><span class="special">&lt;</span><span class="identifier">vdouble3</span><span class="special">&gt;&gt;</span> <span class="identifier">sum</span><span class="special">(</span><span class="identifier">dem_diameter</span><span class="special">);</span>

    <span class="comment">/*
     * vector creates a new double vector of dimension 3
     */</span>
    <span class="identifier">VectorSymbolic</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="number">3</span><span class="special">&gt;</span> <span class="identifier">vector</span><span class="special">;</span>

    <span class="comment">/*
     * perform MD timestepping
     */</span>
    <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">vdouble3</span><span class="special">::</span><span class="identifier">Zero</span><span class="special">();</span>
    <span class="identifier">m</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="number">6.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">PI</span> <span class="special">*</span> <span class="number">8</span> <span class="special">*</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">dem_dens</span><span class="special">;</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">io</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">io</span> <span class="special">&lt;</span> <span class="identifier">nout</span><span class="special">;</span> <span class="special">++</span><span class="identifier">io</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">flush</span><span class="special">;</span>

<span class="preprocessor">#ifdef</span> <span class="identifier">HAVE_VTK</span>
      <span class="identifier">vtkWriteGrid</span><span class="special">(</span><span class="string">"dem"</span><span class="special">,</span> <span class="identifier">io</span><span class="special">,</span> <span class="identifier">dem</span><span class="special">.</span><span class="identifier">get_grid</span><span class="special">(</span><span class="keyword">true</span><span class="special">));</span>
<span class="preprocessor">#endif</span>
      <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">timesteps_per_out</span><span class="special">;</span> <span class="identifier">i</span><span class="special">++)</span> <span class="special">{</span>
        <span class="identifier">p</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">dt</span><span class="special">;</span>

        <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span>
            <span class="special">(</span> <span class="comment">// spring force between dem particles</span>
                <span class="identifier">sum</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">&lt;</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">b</span><span class="special">]</span> <span class="special">&amp;&amp;</span> <span class="identifier">id_</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">!=</span> <span class="identifier">id_</span><span class="special">[</span><span class="identifier">b</span><span class="special">],</span>
                               <span class="special">-</span><span class="identifier">dem_k</span> <span class="special">*</span> <span class="special">((</span><span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+</span> <span class="identifier">r</span><span class="special">[</span><span class="identifier">b</span><span class="special">])</span> <span class="special">/</span> <span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">-</span> <span class="number">1</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dx</span> <span class="special">+</span>
                                   <span class="identifier">dem_gamma</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">v</span><span class="special">[</span><span class="identifier">b</span><span class="special">]</span> <span class="special">-</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]),</span>
                               <span class="identifier">vdouble3</span><span class="special">::</span><span class="identifier">Zero</span><span class="special">()))</span>

                <span class="comment">// spring force between particles and bottom wall</span>
                <span class="special">+</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">-</span> <span class="identifier">p</span><span class="special">[</span><span class="identifier">a</span><span class="special">][</span><span class="number">2</span><span class="special">]</span> <span class="special">&gt;</span> <span class="number">0</span><span class="special">,</span> <span class="identifier">dem_k</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">r</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">-</span> <span class="identifier">p</span><span class="special">[</span><span class="identifier">a</span><span class="special">][</span><span class="number">2</span><span class="special">]),</span> <span class="number">0.0</span><span class="special">)</span> <span class="special">*</span>
                      <span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">1</span><span class="special">)</span>

                <span class="comment">// gravity force</span>
                <span class="special">+</span> <span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="special">-</span><span class="number">9.81</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">m</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span>

                <span class="special">)</span> <span class="special">/</span>
            <span class="identifier">m</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>

        <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">dt</span><span class="special">;</span>
      <span class="special">}</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
  <span class="special">}</span>
</pre>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="aboria.examples.smoothed_particle_hydrodynamics_"></a><a class="link" href="examples.html#aboria.examples.smoothed_particle_hydrodynamics_" title="Smoothed Particle Hydrodynamics (SPH)">Smoothed
      Particle Hydrodynamics (SPH)</a>
</h3></div></div></div>
<p>
        An Smoothed Particle Hydrodynamics example, simulating a 2D water column
        over a no-slip boundary. The <span class="bold"><strong>x</strong></span> and <span class="bold"><strong>y</strong></span> directions are periodic.
      </p>
<p>
        Simulation of a water column in hydrostatic equilibrium. SPH discretises
        the Navier-Stokes equations using radial interpolation kernels defined over
        a given particle set. See the following papers for more details than can
        be described here:
      </p>
<p>
        <a href="http://onlinelibrary.wiley.com/doi/10.1002/fld.2677/abstract" target="_top">M.
        Robinson, J. J. Monaghan, Direct numerical simulation of decaying two-dimensional
        turbulence in a no-slip square box using smoothed par- ticle hydrodynamics,
        International Journal for Numerical Methods in Fluids 70 (1) (2012) 37&#8211;55</a>
      </p>
<p>
        <a href="http://www.sciencedirect.com/science/article/pii/S0301932213001882" target="_top">M.
        Robinson, M. Ramaioli, S. Luding, Fluid-particle flow simulations us- ing
        two-way-coupled mesoscale SPH-DEM and validation, International Journal of
        Multiphase Flow 59 (2014) 121&#8211;134.</a>
      </p>
<p>
        SPH is based on the idea of kernel interpolation. A fluid variable $A(\mathbf{r})$
        (such as velocity or density) is interpolated using a kernel $W$, which depends
        on the smoothing length variable $h$.
      </p>
<p>
        \begin{equation}\label{Eq:integralInterpolant} A(\mathbf{r}) = \int A(\mathbf{r'})W(\mathbf{r}-\mathbf{r'},h)d\mathbf{r'}.
        \end{equation}
      </p>
<p>
        where $m_b$ and $\rho_b$ are the mass and density of particle $b$.
      </p>
<p>
        Here we have used the fifth-order Wendland kernel for $W$, which has the
        form
      </p>
<p>
        \begin{eqnarray} W(q) = \frac{\beta}{h^d} \begin{cases} (2-q)^4(1+2q) &amp;
        \text{for } 0 \leq q \le 2, \ 0 &amp; \text{for } q &gt; 2. \end{cases} \end{eqnarray}
      </p>
<p>
        where $q = ||\mathbf{r}-\mathbf{r'}||/h$.
      </p>
<p>
        The rate of change of density, or continuity equation, is given by
      </p>
<p>
        \begin{equation} \label{Eq:changeInDensity} \frac{D\rho_a}{Dt} = \frac{1}{\Omega_a}\sum_b
        m_b \mathbf{v}_{ab} \cdot <br> abla_a W_{ab}, \end{equation}
      </p>
<p>
        where $\mathbf{v}_{ab}=\mathbf{v}_a-\mathbf{v}_b$. The correction term $\Omega_a$
        due to variable $h$ is given by
      </p>
<p>
        \begin{equation} \Omega_a = 1 - \frac{\partial h_a}{\partial \rho_a} \sum_b
        m_b \frac{\partial W_{ab}(h_a)}{\partial h_a}. \end{equation}
      </p>
<p>
        The equation of state used is the standard quasi-compressible form
      </p>
<p>
        \begin{equation} P = B \left ( \left ( \frac{\rho}{\rho_0} \right )^\gamma
        - 1 \right ), \end{equation}
      </p>
<p>
        where $\gamma = 7$ is a typical value and $\rho_0$ is a reference density
        that is normally set to the density of the fluid.
      </p>
<p>
        The SPH momentum equation is given as below. Viscosity is included by adding
        a viscous term $\Pi$
      </p>
<p>
        \begin{equation}\label{Eq:sphJustPressureForce} \frac{d\mathbf{v}_a}{dt}
        = -\sum_b m_b \left [ \left ( \frac{P_a}{\Omega_a \rho_a^2} + \Pi_{ab} \right
        ) <br> abla_a W_{ab}(h_a) + \left ( \frac{P_b}{\Omega_b \rho_b^2} + \Pi_{ab}
        \right ) <br> abla_a W_{ab}(h_b) \right ], \end{equation}
      </p>
<p>
        The SPH literature contains many different forms for $\Pi$. We have used
        the term
      </p>
<p>
        \begin{equation}\label{Eq:monaghansViscousTerm} \Pi_{ab} = - \alpha \frac{v_{sig}
        (\mathbf{v}_{ab} \cdot \mathbf{r}_{ab} )}{2 \overline{\rho}_{ab} |\mathbf{r}_{ab}|},
        \end{equation}
      </p>
<p>
        where $v_{sig} = 2(c_s + |\mathbf{v}_{ab} \cdot \mathbf{r}_{ab}| / |\mathbf{r}_{ab}|
        )$ is a signal velocity that represents the speed at which information propagates
        between the particles.
      </p>
<p>
        The particle's position and velocity were integrated using the Leapfrog second
        order method, which is also reversible in time in the absence of viscosity.
        To preserve the reversibility of the simulation, $d\rho/dt$ was calculated
        using the particle's position and velocity at the end of the timestep, rather
        than the middle as is commonly done. The full integration scheme is given
        by
      </p>
<p>
        \begin{align} \mathbf{r}^{\frac{1}{2}} &amp;= \mathbf{r}^{0} + \frac{\delta
        t}{2} \mathbf{v}^{0}, \\ \mathbf{v}^{\frac{1}{2}} &amp;= \mathbf{v}^{0} +
        \frac{\delta t}{2} F(\mathbf{r}^{-\frac{1}{2}},\mathbf{v}^{-\frac{1}{2}},\rho^{-\frac{1}{2}}),
        \\ \rho^{\frac{1}{2}} &amp;= \rho^{0} + \frac{\delta t}{2} D(\mathbf{r}^0,\mathbf{v}^0),
        \label{Eq:timestepDensity1} \\ \mathbf{v}^{1} &amp;= \mathbf{v}^{0} + \delta
        t F(\mathbf{r}^{\frac{1}{2}},\mathbf{v}^{\frac{1}{2}},\rho^{\frac{1}{2}}),
        \\ \mathbf{r}^{1} &amp;= \mathbf{r}^{\frac{1}{2}} + \frac{\delta t}{2} \mathbf{v}^{1},
        \\ \rho^{1} &amp;= \rho^{\frac{1}{2}} + \frac{\delta t}{2} D(\mathbf{r}^1,\mathbf{v}^1),
        \label{Eq:timestepDensity2} \end{align}
      </p>
<p>
        where $\mathbf{r}^0$, $\mathbf{r}^{1/2}$ and $\mathbf{r}^1$ is $\mathbf{r}$
        at the start, mid-point and end of the timestep respectively. The functions
        $F$ and $D$ are respectivly the momentum and continuity equations given above.
        The timestep $\delta t$ is bounded by the standard Courant condition
      </p>
<p>
        \begin{equation} \delta t_1 \le \min_a \left ( 0.8 \frac{h_a}{v_{sig}} \right
        ), \end{equation}
      </p>
<p>
        where the minimum is taken over all the particles.
      </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="string">"Aboria.h"</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">Aboria</span><span class="special">;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">math</span><span class="special">/</span><span class="identifier">constants</span><span class="special">/</span><span class="identifier">constants</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">PI</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">math</span><span class="special">::</span><span class="identifier">constants</span><span class="special">::</span><span class="identifier">pi</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;();</span>
<span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">WCON_WENDLAND</span> <span class="special">=</span> <span class="number">21.0</span> <span class="special">/</span> <span class="special">(</span><span class="number">256.0</span> <span class="special">*</span> <span class="identifier">PI</span><span class="special">);</span>
<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="identifier">NDIM</span> <span class="special">=</span> <span class="number">3</span><span class="special">;</span>

<span class="comment">/*
 * Note that we are using standard C++ function objects to implement
 * the kernel W and its gradient F. We can wrap these as lazy Aboria
 * functions that can be used within the symbolic Level 3 API.
 */</span>

<span class="keyword">struct</span> <span class="identifier">F_fun</span> <span class="special">{</span>
  <span class="keyword">typedef</span> <span class="keyword">double</span> <span class="identifier">result_type</span><span class="special">;</span>
  <span class="keyword">double</span> <span class="keyword">operator</span><span class="special">()(</span><span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">r</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">h</span><span class="special">)</span> <span class="keyword">const</span> <span class="special">{</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">r</span> <span class="special">==</span> <span class="number">0</span><span class="special">)</span>
      <span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">q</span> <span class="special">=</span> <span class="identifier">r</span> <span class="special">/</span> <span class="identifier">h</span><span class="special">;</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">q</span> <span class="special">&lt;=</span> <span class="number">2.0</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="special">(</span><span class="number">1</span> <span class="special">/</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">h</span><span class="special">,</span> <span class="identifier">NDIM</span> <span class="special">+</span> <span class="number">2</span><span class="special">))</span> <span class="special">*</span> <span class="identifier">WCON_WENDLAND</span> <span class="special">*</span>
             <span class="special">(-</span><span class="number">4</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="number">2</span> <span class="special">-</span> <span class="identifier">q</span><span class="special">,</span> <span class="number">3</span><span class="special">)</span> <span class="special">*</span> <span class="special">(</span><span class="number">1</span> <span class="special">+</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">q</span><span class="special">)</span> <span class="special">+</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="number">2</span> <span class="special">-</span> <span class="identifier">q</span><span class="special">,</span> <span class="number">4</span><span class="special">))</span> <span class="special">/</span>
             <span class="identifier">q</span><span class="special">;</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="number">0.0</span><span class="special">;</span>
    <span class="special">}</span>
  <span class="special">}</span>
<span class="special">};</span>

<span class="keyword">struct</span> <span class="identifier">W_fun</span> <span class="special">{</span>
  <span class="keyword">typedef</span> <span class="keyword">double</span> <span class="identifier">result_type</span><span class="special">;</span>
  <span class="keyword">double</span> <span class="keyword">operator</span><span class="special">()(</span><span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">r</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">h</span><span class="special">)</span> <span class="keyword">const</span> <span class="special">{</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">q</span> <span class="special">=</span> <span class="identifier">r</span> <span class="special">/</span> <span class="identifier">h</span><span class="special">;</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">q</span> <span class="special">&lt;=</span> <span class="number">2.0</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="special">(</span><span class="number">1</span> <span class="special">/</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">h</span><span class="special">,</span> <span class="identifier">NDIM</span><span class="special">))</span> <span class="special">*</span> <span class="identifier">WCON_WENDLAND</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="number">2.0</span> <span class="special">-</span> <span class="identifier">q</span><span class="special">,</span> <span class="number">4</span><span class="special">)</span> <span class="special">*</span>
             <span class="special">(</span><span class="number">1.0</span> <span class="special">+</span> <span class="number">2.0</span> <span class="special">*</span> <span class="identifier">q</span><span class="special">);</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="number">0.0</span><span class="special">;</span>
    <span class="special">}</span>
  <span class="special">}</span>
<span class="special">};</span>

<span class="identifier">ABORIA_BINARY_FUNCTION</span><span class="special">(</span><span class="identifier">F</span><span class="special">,</span> <span class="identifier">F_fun</span><span class="special">,</span> <span class="identifier">SymbolicDomain</span><span class="special">);</span>
<span class="identifier">ABORIA_BINARY_FUNCTION</span><span class="special">(</span><span class="identifier">W</span><span class="special">,</span> <span class="identifier">W_fun</span><span class="special">,</span> <span class="identifier">SymbolicDomain</span><span class="special">);</span>

    <span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span> <span class="special">{</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">kernel_radius</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"kernel radius"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">velocity</span><span class="special">,</span> <span class="identifier">vdouble3</span><span class="special">,</span> <span class="string">"velocity"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">velocity_tmp</span><span class="special">,</span> <span class="identifier">vdouble3</span><span class="special">,</span> <span class="string">"temp velocity"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">varh_omega</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"varh omega"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">density</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"density"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">total_force</span><span class="special">,</span> <span class="identifier">vdouble3</span><span class="special">,</span> <span class="string">"total force"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">is_fixed</span><span class="special">,</span> <span class="identifier">uint8_t</span><span class="special">,</span> <span class="string">"fixed boundary"</span><span class="special">);</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">pressure_div_density2</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"pressure div density2"</span><span class="special">);</span>

    <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">kernel_radius</span><span class="special">,</span> <span class="identifier">velocity</span><span class="special">,</span> <span class="identifier">velocity_tmp</span><span class="special">,</span> <span class="identifier">varh_omega</span><span class="special">,</span> <span class="identifier">density</span><span class="special">,</span>
                   <span class="identifier">total_force</span><span class="special">,</span> <span class="identifier">is_fixed</span><span class="special">,</span> <span class="identifier">pressure_div_density2</span><span class="special">&gt;,</span>
        <span class="number">3</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">,</span> <span class="identifier">SearchMethod</span><span class="special">&gt;</span>
        <span class="identifier">sph_type</span><span class="special">;</span>
    <span class="keyword">typedef</span> <span class="identifier">position_d</span><span class="special">&lt;</span><span class="number">3</span><span class="special">&gt;</span> <span class="identifier">position</span><span class="special">;</span>
    <span class="identifier">sph_type</span> <span class="identifier">sph</span><span class="special">;</span>

    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;</span> <span class="identifier">p</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">id</span><span class="special">&gt;</span> <span class="identifier">id_</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">velocity</span><span class="special">&gt;</span> <span class="identifier">v</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">velocity_tmp</span><span class="special">&gt;</span> <span class="identifier">v0</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">density</span><span class="special">&gt;</span> <span class="identifier">rho</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">total_force</span><span class="special">&gt;</span> <span class="identifier">dvdt</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">is_fixed</span><span class="special">&gt;</span> <span class="identifier">fixed</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">varh_omega</span><span class="special">&gt;</span> <span class="identifier">omega</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">kernel_radius</span><span class="special">&gt;</span> <span class="identifier">h</span><span class="special">;</span>
    <span class="identifier">Symbol</span><span class="special">&lt;</span><span class="identifier">pressure_div_density2</span><span class="special">&gt;</span> <span class="identifier">pdr2</span><span class="special">;</span>
    <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">0</span><span class="special">,</span> <span class="identifier">sph_type</span><span class="special">&gt;</span> <span class="identifier">a</span><span class="special">(</span><span class="identifier">sph</span><span class="special">);</span>
    <span class="identifier">Label</span><span class="special">&lt;</span><span class="number">1</span><span class="special">,</span> <span class="identifier">sph_type</span><span class="special">&gt;</span> <span class="identifier">b</span><span class="special">(</span><span class="identifier">sph</span><span class="special">);</span>

    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">timesteps</span> <span class="special">=</span> <span class="number">500</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">nout</span> <span class="special">=</span> <span class="number">10</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">timesteps_per_out</span> <span class="special">=</span> <span class="identifier">timesteps</span> <span class="special">/</span> <span class="identifier">nout</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">L</span> <span class="special">=</span> <span class="number">31.0</span> <span class="special">/</span> <span class="number">1000.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">nx</span> <span class="special">=</span> <span class="number">5</span><span class="special">;</span>

    <span class="comment">/*
     * sph parameters
     */</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">hfac</span> <span class="special">=</span> <span class="number">1.5</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">visc</span> <span class="special">=</span> <span class="number">8.9e-07</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">refd</span> <span class="special">=</span> <span class="number">1000.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">dens</span> <span class="special">=</span> <span class="number">1000.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">gamma</span> <span class="special">=</span> <span class="number">7</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">VMAX</span> <span class="special">=</span> <span class="number">2.0</span> <span class="special">*</span> <span class="identifier">sqrt</span><span class="special">(</span><span class="number">2</span> <span class="special">*</span> <span class="number">9.81</span> <span class="special">*</span> <span class="identifier">L</span><span class="special">);</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">CSFAC</span> <span class="special">=</span> <span class="number">10.0</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">spsound</span> <span class="special">=</span> <span class="identifier">CSFAC</span> <span class="special">*</span> <span class="identifier">VMAX</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">prb</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">refd</span> <span class="special">/</span> <span class="identifier">dens</span><span class="special">,</span> <span class="identifier">gamma</span> <span class="special">-</span> <span class="number">1.0</span><span class="special">)</span> <span class="special">*</span>
                       <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">spsound</span><span class="special">,</span> <span class="number">2</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">refd</span> <span class="special">/</span> <span class="identifier">gamma</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">psep</span> <span class="special">=</span> <span class="identifier">L</span> <span class="special">/</span> <span class="identifier">nx</span><span class="special">;</span>
    <span class="keyword">double</span> <span class="identifier">dt</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">min</span><span class="special">(</span><span class="number">0.25</span> <span class="special">*</span> <span class="identifier">hfac</span> <span class="special">*</span> <span class="identifier">psep</span> <span class="special">/</span> <span class="identifier">spsound</span><span class="special">,</span>
                         <span class="number">0.125</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">hfac</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">,</span> <span class="number">2</span><span class="special">)</span> <span class="special">/</span> <span class="identifier">visc</span><span class="special">);</span>
    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">mass</span> <span class="special">=</span> <span class="identifier">dens</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">psep</span><span class="special">,</span> <span class="identifier">NDIM</span><span class="special">);</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"h = "</span> <span class="special">&lt;&lt;</span> <span class="identifier">hfac</span> <span class="special">*</span> <span class="identifier">psep</span> <span class="special">&lt;&lt;</span> <span class="string">" vmax = "</span> <span class="special">&lt;&lt;</span> <span class="identifier">VMAX</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">time_damping</span> <span class="special">=</span> <span class="identifier">dt</span> <span class="special">*</span> <span class="number">500</span><span class="special">;</span>
    <span class="keyword">double</span> <span class="identifier">t</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>

    <span class="keyword">const</span> <span class="identifier">vdouble3</span> <span class="identifier">low</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="special">-</span><span class="number">3.0</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">);</span>
    <span class="keyword">const</span> <span class="identifier">vdouble3</span> <span class="identifier">high</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">L</span><span class="special">,</span> <span class="identifier">L</span><span class="special">);</span>
    <span class="keyword">const</span> <span class="identifier">vbool3</span> <span class="identifier">periodic</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="keyword">true</span><span class="special">,</span> <span class="keyword">false</span><span class="special">);</span>

    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">nx</span><span class="special">;</span> <span class="identifier">i</span><span class="special">++)</span> <span class="special">{</span>
      <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">j</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">j</span> <span class="special">&lt;</span> <span class="identifier">nx</span><span class="special">;</span> <span class="identifier">j</span><span class="special">++)</span> <span class="special">{</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">k</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">k</span> <span class="special">&lt;</span> <span class="identifier">nx</span> <span class="special">+</span> <span class="number">3</span><span class="special">;</span> <span class="identifier">k</span><span class="special">++)</span> <span class="special">{</span>
          <span class="keyword">typename</span> <span class="identifier">sph_type</span><span class="special">::</span><span class="identifier">value_type</span> <span class="identifier">p</span><span class="special">;</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">low</span> <span class="special">+</span> <span class="identifier">vdouble3</span><span class="special">((</span><span class="identifier">i</span> <span class="special">+</span> <span class="number">0.5</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">,</span> <span class="special">(</span><span class="identifier">j</span> <span class="special">+</span> <span class="number">0.5</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">,</span>
                                            <span class="special">(</span><span class="identifier">k</span> <span class="special">+</span> <span class="number">0.5</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">);</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">kernel_radius</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">hfac</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">;</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">velocity</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">);</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">velocity_tmp</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">);</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">varh_omega</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="number">1.0</span><span class="special">;</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">density</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">dens</span><span class="special">;</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">total_force</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">);</span>
          <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">is_fixed</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)[</span><span class="number">2</span><span class="special">]</span> <span class="special">&lt;</span> <span class="number">0</span><span class="special">;</span>
          <span class="identifier">sph</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>
        <span class="special">}</span>
      <span class="special">}</span>
    <span class="special">}</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"starting...."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="identifier">sph</span><span class="special">.</span><span class="identifier">init_neighbour_search</span><span class="special">(</span><span class="identifier">low</span><span class="special">,</span> <span class="identifier">high</span><span class="special">,</span> <span class="identifier">periodic</span><span class="special">);</span>

    <span class="keyword">auto</span> <span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">create_dx</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span> <span class="identifier">b</span><span class="special">);</span>
    <span class="identifier">AccumulateWithinDistance</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">plus</span><span class="special">&lt;</span><span class="identifier">vdouble3</span><span class="special">&gt;&gt;</span> <span class="identifier">sum_vect</span><span class="special">(</span><span class="number">2</span> <span class="special">*</span> <span class="identifier">hfac</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">);</span>
    <span class="identifier">AccumulateWithinDistance</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">plus</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;&gt;</span> <span class="identifier">sum</span><span class="special">(</span><span class="number">2</span> <span class="special">*</span> <span class="identifier">hfac</span> <span class="special">*</span> <span class="identifier">psep</span><span class="special">);</span>
    <span class="identifier">Accumulate</span><span class="special">&lt;</span><span class="identifier">Aboria</span><span class="special">::</span><span class="identifier">max</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;&gt;</span> <span class="identifier">max</span><span class="special">;</span>
    <span class="identifier">max</span><span class="special">.</span><span class="identifier">set_init</span><span class="special">(</span><span class="number">0</span><span class="special">);</span>
    <span class="identifier">Accumulate</span><span class="special">&lt;</span><span class="identifier">Aboria</span><span class="special">::</span><span class="identifier">min</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;&gt;</span> <span class="identifier">min</span><span class="special">;</span>
    <span class="identifier">min</span><span class="special">.</span><span class="identifier">set_init</span><span class="special">(</span><span class="identifier">L</span><span class="special">);</span>
    <span class="identifier">VectorSymbolic</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="number">3</span><span class="special">&gt;</span> <span class="identifier">vector</span><span class="special">;</span>

    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">nout</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
<span class="preprocessor">#ifdef</span> <span class="identifier">HAVE_VTK</span>
      <span class="identifier">vtkWriteGrid</span><span class="special">(</span><span class="string">"sph"</span><span class="special">,</span> <span class="identifier">i</span><span class="special">,</span> <span class="identifier">sph</span><span class="special">.</span><span class="identifier">get_grid</span><span class="special">(</span><span class="keyword">true</span><span class="special">));</span>
<span class="preprocessor">#endif</span>
      <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">k</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">k</span> <span class="special">&lt;</span> <span class="identifier">timesteps_per_out</span><span class="special">;</span> <span class="special">++</span><span class="identifier">k</span><span class="special">)</span> <span class="special">{</span>
        <span class="comment">/*
         * 0 -&gt; 1/2 step
         */</span>
        <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">fixed</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">==</span> <span class="keyword">false</span><span class="special">,</span> <span class="identifier">dt</span> <span class="special">/</span> <span class="number">2</span><span class="special">,</span> <span class="number">0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">t</span> <span class="special">&lt;</span> <span class="identifier">time_damping</span><span class="special">)</span>
          <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*=</span> <span class="number">0.98</span><span class="special">;</span>
        <span class="identifier">p</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">dt</span> <span class="special">/</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>

        <span class="comment">/*
         * Calculate omega
         */</span>
        <span class="identifier">omega</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span>
            <span class="number">1.0</span> <span class="special">-</span> <span class="special">(</span><span class="identifier">mass</span> <span class="special">/</span> <span class="special">(</span><span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">NDIM</span><span class="special">))</span> <span class="special">*</span>
                      <span class="identifier">sum</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">&lt;</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span>
                                     <span class="identifier">pow</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="number">2</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">F</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">])</span> <span class="special">+</span>
                                         <span class="identifier">NDIM</span> <span class="special">*</span> <span class="identifier">W</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">]),</span>
                                     <span class="number">0</span><span class="special">));</span>

        <span class="comment">/*
         * 1/2 -&gt; 1 step
         */</span>

        <span class="comment">/*
         * calculate change in density and kernel radius
         */</span>
        <span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">dt</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">mass</span> <span class="special">/</span> <span class="identifier">omega</span><span class="special">[</span><span class="identifier">a</span><span class="special">])</span> <span class="special">*</span>
                  <span class="identifier">sum</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">&lt;</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span>
                                 <span class="identifier">dot</span><span class="special">(</span><span class="identifier">v</span><span class="special">[</span><span class="identifier">b</span><span class="special">]</span> <span class="special">-</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span> <span class="identifier">dx</span> <span class="special">*</span> <span class="identifier">F</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">])),</span> <span class="number">0</span><span class="special">));</span>
        <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">pow</span><span class="special">(</span><span class="identifier">mass</span> <span class="special">/</span> <span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span> <span class="number">1.0</span> <span class="special">/</span> <span class="identifier">NDIM</span><span class="special">);</span>

        <span class="comment">/*
         * reset neighbour search for new kernel radius
         */</span>
        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">maxh</span> <span class="special">=</span> <span class="identifier">eval</span><span class="special">(</span><span class="identifier">max</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">]));</span>
        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">minh</span> <span class="special">=</span> <span class="identifier">eval</span><span class="special">(</span><span class="identifier">min</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">]));</span>
        <span class="identifier">sum_vect</span><span class="special">.</span><span class="identifier">set_max_distance</span><span class="special">(</span><span class="number">2</span> <span class="special">*</span> <span class="identifier">maxh</span><span class="special">);</span>
        <span class="identifier">sum</span><span class="special">.</span><span class="identifier">set_max_distance</span><span class="special">(</span><span class="number">2</span> <span class="special">*</span> <span class="identifier">maxh</span><span class="special">);</span>

        <span class="comment">/*
         * advance velocity, position and calculate pdr2
         */</span>
        <span class="identifier">v0</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>
        <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">fixed</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">==</span> <span class="keyword">false</span><span class="special">,</span> <span class="identifier">dt</span> <span class="special">/</span> <span class="number">2.0</span><span class="special">,</span> <span class="number">0.0</span><span class="special">)</span> <span class="special">*</span> <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>
        <span class="identifier">pdr2</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">prb</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">/</span> <span class="identifier">refd</span><span class="special">,</span> <span class="identifier">gamma</span><span class="special">)</span> <span class="special">-</span> <span class="number">1.0</span><span class="special">)</span> <span class="special">/</span> <span class="identifier">pow</span><span class="special">(</span><span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span> <span class="number">2</span><span class="special">);</span>
        <span class="identifier">p</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span> <span class="identifier">dt</span> <span class="special">/</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">v0</span><span class="special">[</span><span class="identifier">a</span><span class="special">];</span>

        <span class="comment">/*
         * acceleration due to gravity
         */</span>
        <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">vdouble3</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="special">-</span><span class="number">9.81</span><span class="special">);</span>

        <span class="comment">/*
         * acceleration on SPH calculation
         */</span>
        <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+=</span>
            <span class="identifier">mass</span> <span class="special">*</span>
            <span class="identifier">sum_vect</span><span class="special">(</span><span class="identifier">b</span><span class="special">,</span>
                     <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">)</span> <span class="special">&lt;</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span>

                             <span class="comment">// pressure force</span>
                             <span class="special">((</span><span class="number">1.0</span> <span class="special">/</span> <span class="identifier">omega</span><span class="special">[</span><span class="identifier">a</span><span class="special">])</span> <span class="special">*</span> <span class="identifier">pdr2</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">F</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">])</span> <span class="special">+</span>
                              <span class="special">(</span><span class="number">1.0</span> <span class="special">/</span> <span class="identifier">omega</span><span class="special">[</span><span class="identifier">b</span><span class="special">])</span> <span class="special">*</span> <span class="identifier">pdr2</span><span class="special">[</span><span class="identifier">b</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">F</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">b</span><span class="special">]))</span> <span class="special">*</span>
                                     <span class="identifier">dx</span>

                                 <span class="comment">// viscous force</span>
                                 <span class="special">+</span> <span class="special">(</span><span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">-</span> <span class="identifier">v</span><span class="special">[</span><span class="identifier">b</span><span class="special">])</span> <span class="special">*</span> <span class="identifier">visc</span> <span class="special">*</span> <span class="special">(</span><span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+</span> <span class="identifier">rho</span><span class="special">[</span><span class="identifier">b</span><span class="special">])</span> <span class="special">/</span>
                                       <span class="special">(</span><span class="identifier">rho</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">*</span> <span class="identifier">rho</span><span class="special">[</span><span class="identifier">b</span><span class="special">])</span> <span class="special">*</span> <span class="identifier">F</span><span class="special">(</span><span class="identifier">norm</span><span class="special">(</span><span class="identifier">dx</span><span class="special">),</span> <span class="identifier">h</span><span class="special">[</span><span class="identifier">a</span><span class="special">])</span>

                                 <span class="special">,</span>
                             <span class="identifier">vector</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">)));</span>

        <span class="comment">/*
         * 1/2 -&gt; 1 step for velocity
         */</span>
        <span class="identifier">v</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">if_else</span><span class="special">(</span><span class="identifier">fixed</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">==</span> <span class="keyword">false</span><span class="special">,</span> <span class="identifier">v0</span><span class="special">[</span><span class="identifier">a</span><span class="special">]</span> <span class="special">+</span> <span class="identifier">dt</span> <span class="special">/</span> <span class="number">2</span> <span class="special">*</span> <span class="identifier">dvdt</span><span class="special">[</span><span class="identifier">a</span><span class="special">],</span>
                       <span class="identifier">vector</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">));</span>

        <span class="identifier">t</span> <span class="special">+=</span> <span class="identifier">dt</span><span class="special">;</span>

        <span class="comment">/*
         * sph timestep condition
         */</span>
        <span class="identifier">dt</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">min</span><span class="special">(</span><span class="number">0.25</span> <span class="special">*</span> <span class="identifier">minh</span> <span class="special">/</span> <span class="identifier">spsound</span><span class="special">,</span> <span class="number">0.125</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">minh</span><span class="special">,</span> <span class="number">2</span><span class="special">)</span> <span class="special">/</span> <span class="identifier">visc</span><span class="special">);</span>
      <span class="special">}</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"iteration "</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="special">}</span>
  <span class="special">}</span>
</pre>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="aboria.examples.radial_basis_function_rbf_interp"></a><a class="link" href="examples.html#aboria.examples.radial_basis_function_rbf_interp" title="Radial Basis Function (RBF) Interpolation">Radial
      Basis Function (RBF) Interpolation</a>
</h3></div></div></div>
<p>
        Here we interpolate a function $f(x,y)$ over the two-dimensional unit cube
        from $(0,0)$ to $(1,1)$, using the multiquadric Radial Basis Function (RBF).
      </p>
<p>
        The function to be interpolated is
      </p>
<p>
        \begin{equation} f(x,y) = \exp(-9(x-\frac{1}{2})^2 - 9(y-\frac{1}{4})^2),
        \end{equation}
      </p>
<p>
        and the multiquadric RBF $K(r)$ is given by
      </p>
<p>
        \begin{equation} K(r) = \sqrt{r^2 + c^2}. \end{equation}
      </p>
<p>
        We create a set of basis functions around a set of $N$ particles with positions
        $\mathbf{x}_i$. In this case the radial coordinate around each point is $r
        = ||\mathbf{x}_i - \mathbf{x}||$. The function $f$ is approximated using
        the sum of these basis functions, with the addition of a constant factor
        $\beta$
      </p>
<p>
        \begin{equation} \overline{f}(\mathbf{x}) = \beta + \sum_i \alpha_j K(||\mathbf{x}_i-\mathbf{x}||).
        \end{equation}
      </p>
<p>
        We exactly interpolate the function at $\mathbf{x}_i$ (i.e. set $\overline{f}(\mathbf{x}_i)=f(\mathbf{x}_i)$),
        leading to
      </p>
<p>
        \begin{equation} f(\mathbf{x}_i) = \beta + \sum_j \alpha_j K(||\mathbf{x}_j-\mathbf{x}_i||).
        \end{equation}
      </p>
<p>
        Note that the sum $j$ is over the same particle set.
      </p>
<p>
        We also need one additional constraint to find $\beta$
      </p>
<p>
        \begin{equation} 0 = \sum_j \alpha_j. \end{equation}
      </p>
<p>
        We rewrite the two previous equations as a linear algebra expression
      </p>
<p>
        \begin{equation} \mathbf{\Phi} = \begin{bmatrix} \mathbf{G}&amp;\mathbf{P}
        \\ \mathbf{P}^T &amp; \mathbf{0} \end{bmatrix} \begin{bmatrix} \mathbf{\alpha}
        \\ \mathbf{\beta} \end{bmatrix} = \mathbf{W} \mathbf{\gamma}, \end{equation}
      </p>
<p>
        where $\mathbf{\Phi} = [f(\mathbf{x}_1),f(\mathbf{x}_2),...,f(\mathbf{x}_N),0]$,
        $\mathbf{G}$ is an $N \times N$ matrix with elements $G_{ij} = K(||\mathbf{x}_j-\mathbf{x}_i||)$
        and $\mathbf{P}$ is a $N \times 1$ vector of ones.
      </p>
<p>
        The basis function coefficients $\mathbf{\gamma}$ are found by solving this
        equation. To do this, we use the iterative solvers found in the Eigen package
        and Aboria's ability to wrap C++ function objects as Eigen matricies.
      </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="string">"Aboria.h"</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">random</span><span class="special">&gt;</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">Aboria</span><span class="special">;</span>

    <span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span> <span class="special">{</span>
    <span class="keyword">auto</span> <span class="identifier">funct</span> <span class="special">=</span> <span class="special">[](</span><span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exp</span><span class="special">(-</span><span class="number">9</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">x</span> <span class="special">-</span> <span class="number">0.5</span><span class="special">,</span> <span class="number">2</span><span class="special">)</span> <span class="special">-</span> <span class="number">9</span> <span class="special">*</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">y</span> <span class="special">-</span> <span class="number">0.25</span><span class="special">,</span> <span class="number">2</span><span class="special">));</span>
      <span class="comment">// return x;</span>
    <span class="special">};</span>

    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">alpha</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"alpha value"</span><span class="special">)</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">interpolated</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"interpolated value"</span><span class="special">)</span>
    <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">constant2</span><span class="special">,</span> <span class="keyword">double</span><span class="special">,</span> <span class="string">"c2 value"</span><span class="special">)</span>

    <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">alpha</span><span class="special">,</span> <span class="identifier">constant2</span><span class="special">,</span> <span class="identifier">interpolated</span><span class="special">&gt;,</span> <span class="number">2</span><span class="special">,</span>
                      <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">,</span> <span class="identifier">SearchMethod</span><span class="special">&gt;</span>
        <span class="identifier">ParticlesType</span><span class="special">;</span>
    <span class="keyword">typedef</span> <span class="identifier">position_d</span><span class="special">&lt;</span><span class="number">2</span><span class="special">&gt;</span> <span class="identifier">position</span><span class="special">;</span>
    <span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="identifier">ParticlesType</span><span class="special">::</span><span class="identifier">const_reference</span> <span class="identifier">const_particle_reference</span><span class="special">;</span>
    <span class="keyword">typedef</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Matrix</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Dynamic</span><span class="special">,</span> <span class="number">1</span><span class="special">&gt;</span> <span class="identifier">vector_type</span><span class="special">;</span>
    <span class="keyword">typedef</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Matrix</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Dynamic</span><span class="special">,</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Dynamic</span><span class="special">&gt;</span> <span class="identifier">matrix_type</span><span class="special">;</span>
    <span class="identifier">ParticlesType</span> <span class="identifier">knots</span><span class="special">;</span>
    <span class="identifier">ParticlesType</span> <span class="identifier">augment</span><span class="special">;</span>
    <span class="identifier">ParticlesType</span> <span class="identifier">test</span><span class="special">;</span>

    <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">c</span> <span class="special">=</span> <span class="number">0.5</span><span class="special">;</span>

    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">N</span> <span class="special">=</span> <span class="number">1000</span><span class="special">;</span>

    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">max_iter</span> <span class="special">=</span> <span class="number">100</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">restart</span> <span class="special">=</span> <span class="number">101</span><span class="special">;</span>
    <span class="keyword">typename</span> <span class="identifier">ParticlesType</span><span class="special">::</span><span class="identifier">value_type</span> <span class="identifier">p</span><span class="special">;</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">default_random_engine</span> <span class="identifier">generator</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">uniform_real_distribution</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;</span> <span class="identifier">distribution</span><span class="special">(</span><span class="number">0.0</span><span class="special">,</span> <span class="number">1.0</span><span class="special">);</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">N</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span>
          <span class="identifier">vdouble2</span><span class="special">(</span><span class="identifier">distribution</span><span class="special">(</span><span class="identifier">generator</span><span class="special">),</span> <span class="identifier">distribution</span><span class="special">(</span><span class="identifier">generator</span><span class="special">));</span>
      <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">c</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
      <span class="identifier">knots</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>

      <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span>
          <span class="identifier">vdouble2</span><span class="special">(</span><span class="identifier">distribution</span><span class="special">(</span><span class="identifier">generator</span><span class="special">),</span> <span class="identifier">distribution</span><span class="special">(</span><span class="identifier">generator</span><span class="special">));</span>
      <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">c</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
      <span class="identifier">test</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// knots.init_neighbour_search(min,max,periodic);</span>

    <span class="identifier">augment</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>

    <span class="keyword">auto</span> <span class="identifier">kernel</span> <span class="special">=</span> <span class="special">[](</span><span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span> <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">((</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">)</span> <span class="special">-</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">a</span><span class="special">)).</span><span class="identifier">squaredNorm</span><span class="special">()</span> <span class="special">+</span>
                       <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">));</span>
    <span class="special">};</span>

    <span class="keyword">auto</span> <span class="identifier">one</span> <span class="special">=</span> <span class="special">[](</span><span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span> <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">return</span> <span class="number">1.0</span><span class="special">;</span>
    <span class="special">};</span>

    <span class="keyword">auto</span> <span class="identifier">G</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">knots</span><span class="special">,</span> <span class="identifier">knots</span><span class="special">,</span> <span class="identifier">kernel</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">P</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">knots</span><span class="special">,</span> <span class="identifier">augment</span><span class="special">,</span> <span class="identifier">one</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">Pt</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">augment</span><span class="special">,</span> <span class="identifier">knots</span><span class="special">,</span> <span class="identifier">one</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">Zero</span> <span class="special">=</span> <span class="identifier">create_zero_operator</span><span class="special">(</span><span class="identifier">augment</span><span class="special">,</span> <span class="identifier">augment</span><span class="special">);</span>

    <span class="keyword">auto</span> <span class="identifier">W</span> <span class="special">=</span> <span class="identifier">create_block_operator</span><span class="special">&lt;</span><span class="number">2</span><span class="special">,</span> <span class="number">2</span><span class="special">&gt;(</span><span class="identifier">G</span><span class="special">,</span> <span class="identifier">P</span><span class="special">,</span> <span class="identifier">Pt</span><span class="special">,</span> <span class="identifier">Zero</span><span class="special">);</span>

    <span class="keyword">auto</span> <span class="identifier">G_test</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">test</span><span class="special">,</span> <span class="identifier">knots</span><span class="special">,</span> <span class="identifier">kernel</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">W_test</span> <span class="special">=</span> <span class="identifier">create_block_operator</span><span class="special">&lt;</span><span class="number">2</span><span class="special">,</span> <span class="number">2</span><span class="special">&gt;(</span><span class="identifier">G_test</span><span class="special">,</span> <span class="identifier">P</span><span class="special">,</span> <span class="identifier">Pt</span><span class="special">,</span> <span class="identifier">Zero</span><span class="special">);</span>

    <span class="identifier">vector_type</span> <span class="identifier">phi</span><span class="special">(</span><span class="identifier">N</span> <span class="special">+</span> <span class="number">1</span><span class="special">),</span> <span class="identifier">gamma</span><span class="special">(</span><span class="identifier">N</span> <span class="special">+</span> <span class="number">1</span><span class="special">);</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">knots</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">0</span><span class="special">];</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">1</span><span class="special">];</span>
      <span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span> <span class="identifier">y</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="identifier">phi</span><span class="special">[</span><span class="identifier">knots</span><span class="special">.</span><span class="identifier">size</span><span class="special">()]</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>

    <span class="identifier">matrix_type</span> <span class="identifier">W_matrix</span><span class="special">(</span><span class="identifier">N</span> <span class="special">+</span> <span class="number">1</span><span class="special">,</span> <span class="identifier">N</span> <span class="special">+</span> <span class="number">1</span><span class="special">);</span>
    <span class="identifier">W</span><span class="special">.</span><span class="identifier">assemble</span><span class="special">(</span><span class="identifier">W_matrix</span><span class="special">);</span>

    <span class="identifier">gamma</span> <span class="special">=</span> <span class="identifier">W_matrix</span><span class="special">.</span><span class="identifier">ldlt</span><span class="special">().</span><span class="identifier">solve</span><span class="special">(</span><span class="identifier">phi</span><span class="special">);</span>

    <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">GMRES</span><span class="special">&lt;</span><span class="identifier">matrix_type</span><span class="special">&gt;</span> <span class="identifier">gmres</span><span class="special">;</span>
    <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">setMaxIterations</span><span class="special">(</span><span class="identifier">max_iter</span><span class="special">);</span>
    <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">set_restart</span><span class="special">(</span><span class="identifier">restart</span><span class="special">);</span>
    <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">compute</span><span class="special">(</span><span class="identifier">W_matrix</span><span class="special">);</span>
    <span class="identifier">gamma</span> <span class="special">=</span> <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">solve</span><span class="special">(</span><span class="identifier">phi</span><span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"GMRES:       #iterations: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">iterations</span><span class="special">()</span>
              <span class="special">&lt;&lt;</span> <span class="string">", estimated error: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">error</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

    <span class="identifier">phi</span> <span class="special">=</span> <span class="identifier">W</span> <span class="special">*</span> <span class="identifier">gamma</span><span class="special">;</span>
    <span class="keyword">double</span> <span class="identifier">rms_error</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="keyword">double</span> <span class="identifier">scale</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">knots</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">0</span><span class="special">];</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">1</span><span class="special">];</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">truth</span> <span class="special">=</span> <span class="identifier">funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span> <span class="identifier">y</span><span class="special">);</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">eval_value</span> <span class="special">=</span> <span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">];</span>
      <span class="identifier">rms_error</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">eval_value</span> <span class="special">-</span> <span class="identifier">truth</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
      <span class="identifier">scale</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">truth</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
      <span class="comment">// TS_ASSERT_DELTA(eval_value,truth,2e-3);</span>
    <span class="special">}</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"rms_error for global support, at centers  = "</span>
              <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">rms_error</span> <span class="special">/</span> <span class="identifier">scale</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="identifier">TS_ASSERT_LESS_THAN</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">rms_error</span> <span class="special">/</span> <span class="identifier">scale</span><span class="special">),</span> <span class="number">1e-6</span><span class="special">);</span>

    <span class="identifier">phi</span> <span class="special">=</span> <span class="identifier">W_test</span> <span class="special">*</span> <span class="identifier">gamma</span><span class="special">;</span>
    <span class="identifier">rms_error</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="identifier">scale</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">test</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">test</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">0</span><span class="special">];</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">test</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">1</span><span class="special">];</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">truth</span> <span class="special">=</span> <span class="identifier">funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span> <span class="identifier">y</span><span class="special">);</span>
      <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">eval_value</span> <span class="special">=</span> <span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">];</span>
      <span class="identifier">rms_error</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">eval_value</span> <span class="special">-</span> <span class="identifier">truth</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
      <span class="identifier">scale</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">truth</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
      <span class="comment">// TS_ASSERT_DELTA(eval_value,truth,2e-3);</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"rms_error for global support, away from centers  = "</span>
              <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">rms_error</span> <span class="special">/</span> <span class="identifier">scale</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="identifier">TS_ASSERT_LESS_THAN</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">rms_error</span> <span class="special">/</span> <span class="identifier">scale</span><span class="special">),</span> <span class="number">1e-5</span><span class="special">);</span>

<span class="special">}</span>
</pre>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="aboria.examples.kansa_method_for_pdes"></a><a class="link" href="examples.html#aboria.examples.kansa_method_for_pdes" title="Kansa Method for PDEs">Kansa Method for
      PDEs</a>
</h3></div></div></div>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="string">"Aboria.h"</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">Aboria</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span> <span class="special">{</span>
        <span class="keyword">auto</span> <span class="identifier">funct</span> <span class="special">=</span> <span class="special">[](</span><span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">cos</span><span class="special">(</span><span class="number">4</span><span class="special">*</span><span class="identifier">x</span><span class="special">+</span><span class="number">4</span><span class="special">*</span><span class="identifier">y</span><span class="special">);</span>
        <span class="special">};</span>

        <span class="keyword">auto</span> <span class="identifier">laplace_funct</span> <span class="special">=</span> <span class="special">[](</span><span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">return</span> <span class="special">-</span><span class="number">32</span><span class="special">*</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">cos</span><span class="special">(</span><span class="number">4</span><span class="special">*</span><span class="identifier">x</span><span class="special">+</span><span class="number">4</span><span class="special">*</span><span class="identifier">y</span><span class="special">);</span>
        <span class="special">};</span>

        <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">boundary</span><span class="special">,</span><span class="identifier">uint8_t</span><span class="special">,</span><span class="string">"is boundary knot"</span><span class="special">)</span>
        <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">interpolated</span><span class="special">,</span><span class="keyword">double</span><span class="special">,</span><span class="string">"interpolated value"</span><span class="special">)</span>
        <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">constant2</span><span class="special">,</span><span class="keyword">double</span><span class="special">,</span><span class="string">"c2 value"</span><span class="special">)</span>
        <span class="identifier">ABORIA_VARIABLE</span><span class="special">(</span><span class="identifier">alpha</span><span class="special">,</span><span class="keyword">double</span><span class="special">,</span><span class="string">"alpha value"</span><span class="special">)</span>

     <span class="keyword">typedef</span> <span class="identifier">Particles</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">alpha</span><span class="special">,</span><span class="identifier">boundary</span><span class="special">,</span><span class="identifier">constant2</span><span class="special">,</span><span class="identifier">interpolated</span><span class="special">&gt;,</span><span class="number">2</span><span class="special">&gt;</span> <span class="identifier">ParticlesType</span><span class="special">;</span>

        <span class="keyword">typedef</span> <span class="identifier">position_d</span><span class="special">&lt;</span><span class="number">2</span><span class="special">&gt;</span> <span class="identifier">position</span><span class="special">;</span>
        <span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="identifier">ParticlesType</span><span class="special">::</span><span class="identifier">const_reference</span> <span class="identifier">const_particle_reference</span><span class="special">;</span>
        <span class="keyword">typedef</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Map</span><span class="special">&lt;</span><span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Matrix</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span><span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Dynamic</span><span class="special">,</span><span class="number">1</span><span class="special">&gt;&gt;</span> <span class="identifier">map_type</span><span class="special">;</span>
        <span class="keyword">typedef</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Matrix</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span><span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">Dynamic</span><span class="special">,</span><span class="number">1</span><span class="special">&gt;</span> <span class="identifier">vector_type</span><span class="special">;</span>
       	<span class="identifier">ParticlesType</span> <span class="identifier">knots</span><span class="special">,</span><span class="identifier">augment</span><span class="special">;</span>

       	<span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">c</span> <span class="special">=</span> <span class="number">0.5</span><span class="special">;</span>
        <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">max_iter</span> <span class="special">=</span> <span class="number">100</span><span class="special">;</span>
        <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">restart</span> <span class="special">=</span> <span class="number">100</span><span class="special">;</span>

        <span class="keyword">const</span> <span class="keyword">int</span> <span class="identifier">nx</span> <span class="special">=</span> <span class="number">7</span><span class="special">;</span>
        <span class="keyword">constexpr</span> <span class="keyword">int</span> <span class="identifier">N</span> <span class="special">=</span> <span class="special">(</span><span class="identifier">nx</span><span class="special">+</span><span class="number">1</span><span class="special">)*(</span><span class="identifier">nx</span><span class="special">+</span><span class="number">1</span><span class="special">);</span>
        <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">delta</span> <span class="special">=</span> <span class="number">1.0</span><span class="special">/</span><span class="identifier">nx</span><span class="special">;</span>
        <span class="keyword">typename</span> <span class="identifier">ParticlesType</span><span class="special">::</span><span class="identifier">value_type</span> <span class="identifier">p</span><span class="special">;</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">i</span><span class="special">&lt;=</span><span class="identifier">nx</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">j</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">j</span><span class="special">&lt;=</span><span class="identifier">nx</span><span class="special">;</span> <span class="special">++</span><span class="identifier">j</span><span class="special">)</span> <span class="special">{</span>
                <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">vdouble2</span><span class="special">(</span><span class="identifier">i</span><span class="special">*</span><span class="identifier">delta</span><span class="special">,</span><span class="identifier">j</span><span class="special">*</span><span class="identifier">delta</span><span class="special">);</span>
                <span class="keyword">if</span> <span class="special">((</span><span class="identifier">i</span><span class="special">==</span><span class="number">0</span><span class="special">)||(</span><span class="identifier">i</span><span class="special">==</span><span class="identifier">nx</span><span class="special">)||(</span><span class="identifier">j</span><span class="special">==</span><span class="number">0</span><span class="special">)||(</span><span class="identifier">j</span><span class="special">==</span><span class="identifier">nx</span><span class="special">))</span> <span class="special">{</span>
                    <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>
                <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
                    <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="keyword">false</span><span class="special">;</span>
                <span class="special">}</span>
                <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">p</span><span class="special">)</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">c</span><span class="special">,</span><span class="number">2</span><span class="special">);</span>
                <span class="identifier">knots</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>
            <span class="special">}</span>
        <span class="special">}</span>
        <span class="identifier">augment</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">p</span><span class="special">);</span>

        <span class="keyword">auto</span> <span class="identifier">kernel</span> <span class="special">=</span> <span class="special">[](</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
             <span class="keyword">const</span> <span class="identifier">vdouble2</span> <span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">)</span> <span class="special">-</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">a</span><span class="special">);</span>
             <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exp</span><span class="special">(-</span><span class="identifier">dx</span><span class="special">.</span><span class="identifier">squaredNorm</span><span class="special">()/</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">));</span>
                        <span class="special">};</span>

        <span class="keyword">auto</span> <span class="identifier">laplace_kernel</span> <span class="special">=</span> <span class="special">[](</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
             <span class="keyword">const</span> <span class="identifier">vdouble2</span> <span class="identifier">dx</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">)</span> <span class="special">-</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">a</span><span class="special">);</span>
             <span class="keyword">return</span> <span class="number">4.0</span><span class="special">*(</span><span class="identifier">dx</span><span class="special">.</span><span class="identifier">squaredNorm</span><span class="special">()-</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">))*</span>
                        <span class="identifier">std</span><span class="special">::</span><span class="identifier">exp</span><span class="special">(-</span><span class="identifier">dx</span><span class="special">.</span><span class="identifier">squaredNorm</span><span class="special">()/</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">))/</span>
                            <span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">)*</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">constant2</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">));</span>
                        <span class="special">};</span>

        <span class="keyword">auto</span> <span class="identifier">G</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">knots</span><span class="special">,</span><span class="identifier">knots</span><span class="special">,</span>
                <span class="special">[</span><span class="identifier">kernel</span><span class="special">,</span><span class="identifier">laplace_kernel</span><span class="special">](</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
                    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">a</span><span class="special">))</span> <span class="special">{</span>
                        <span class="keyword">return</span> <span class="identifier">kernel</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span><span class="identifier">b</span><span class="special">);</span>
                    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
                        <span class="keyword">return</span> <span class="identifier">laplace_kernel</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span><span class="identifier">b</span><span class="special">);</span>
                    <span class="special">}</span>
                    <span class="special">});</span>

        <span class="keyword">auto</span> <span class="identifier">P</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">knots</span><span class="special">,</span><span class="identifier">augment</span><span class="special">,</span>
                <span class="special">[](</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
                    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">a</span><span class="special">))</span> <span class="special">{</span>
                        <span class="keyword">return</span> <span class="number">1.0</span><span class="special">;</span>
                    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
                        <span class="keyword">return</span> <span class="number">0.0</span><span class="special">;</span>
                    <span class="special">}</span>
                    <span class="special">});</span>

        <span class="keyword">auto</span> <span class="identifier">Pt</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">augment</span><span class="special">,</span><span class="identifier">knots</span><span class="special">,</span>
                <span class="special">[](</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">a</span><span class="special">,</span>
                         <span class="identifier">const_particle_reference</span> <span class="identifier">b</span><span class="special">)</span> <span class="special">{</span>
                    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">b</span><span class="special">))</span> <span class="special">{</span>
                        <span class="keyword">return</span> <span class="number">1.0</span><span class="special">;</span>
                    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
                        <span class="keyword">return</span> <span class="number">0.0</span><span class="special">;</span>
                    <span class="special">}</span>
                    <span class="special">});</span>

        <span class="keyword">auto</span> <span class="identifier">Zero</span> <span class="special">=</span> <span class="identifier">create_zero_operator</span><span class="special">(</span><span class="identifier">augment</span><span class="special">,</span><span class="identifier">augment</span><span class="special">);</span>

        <span class="keyword">auto</span> <span class="identifier">W</span> <span class="special">=</span> <span class="identifier">create_block_operator</span><span class="special">&lt;</span><span class="number">2</span><span class="special">,</span><span class="number">2</span><span class="special">&gt;(</span><span class="identifier">G</span><span class="special">,</span> <span class="identifier">P</span><span class="special">,</span>
                                            <span class="identifier">Pt</span><span class="special">,</span><span class="identifier">Zero</span><span class="special">);</span>


        <span class="identifier">vector_type</span> <span class="identifier">phi</span><span class="special">(</span><span class="identifier">N</span><span class="special">+</span><span class="number">1</span><span class="special">),</span> <span class="identifier">gamma</span><span class="special">(</span><span class="identifier">N</span><span class="special">+</span><span class="number">1</span><span class="special">);</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">i</span><span class="special">&lt;</span><span class="identifier">N</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">0</span><span class="special">];</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">1</span><span class="special">];</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">]))</span> <span class="special">{</span>
                <span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span><span class="identifier">y</span><span class="special">);</span>
            <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
                <span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">laplace_funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span><span class="identifier">y</span><span class="special">);</span>
            <span class="special">}</span>
        <span class="special">}</span>
        <span class="identifier">phi</span><span class="special">[</span><span class="identifier">N</span><span class="special">]</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>

        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

        <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">GMRES</span><span class="special">&lt;</span><span class="keyword">decltype</span><span class="special">(</span><span class="identifier">W</span><span class="special">),</span> <span class="identifier">Eigen</span><span class="special">::</span><span class="identifier">DiagonalPreconditioner</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">&gt;&gt;</span> <span class="identifier">gmres</span><span class="special">;</span>
        <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">set_restart</span><span class="special">(</span><span class="identifier">restart</span><span class="special">);</span>
        <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">setMaxIterations</span><span class="special">(</span><span class="identifier">max_iter</span><span class="special">);</span>
        <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">compute</span><span class="special">(</span><span class="identifier">W</span><span class="special">);</span>
        <span class="identifier">gamma</span> <span class="special">=</span> <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">solve</span><span class="special">(</span><span class="identifier">phi</span><span class="special">);</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"GMRES:    #iterations: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">iterations</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">", estimated error: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">gmres</span><span class="special">.</span><span class="identifier">error</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

        <span class="identifier">phi</span> <span class="special">=</span> <span class="identifier">W</span><span class="special">*</span><span class="identifier">gamma</span><span class="special">;</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">i</span><span class="special">&lt;</span><span class="identifier">N</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">0</span><span class="special">];</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">1</span><span class="special">];</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">boundary</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">]))</span> <span class="special">{</span>
                <span class="identifier">TS_ASSERT_DELTA</span><span class="special">(</span><span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">],</span><span class="identifier">funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span><span class="identifier">y</span><span class="special">),</span><span class="number">2e-3</span><span class="special">);</span>
            <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
                <span class="identifier">TS_ASSERT_DELTA</span><span class="special">(</span><span class="identifier">phi</span><span class="special">[</span><span class="identifier">i</span><span class="special">],</span><span class="identifier">laplace_funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span><span class="identifier">y</span><span class="special">),</span><span class="number">2e-3</span><span class="special">);</span>
            <span class="special">}</span>
        <span class="special">}</span>
        <span class="identifier">TS_ASSERT_DELTA</span><span class="special">(</span><span class="identifier">phi</span><span class="special">[</span><span class="identifier">N</span><span class="special">],</span><span class="number">0</span><span class="special">,</span><span class="number">2e-3</span><span class="special">);</span>


        <span class="identifier">map_type</span> <span class="identifier">alpha_wrap</span><span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">alpha</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">).</span><span class="identifier">data</span><span class="special">(),</span><span class="identifier">N</span><span class="special">);</span>
        <span class="identifier">map_type</span> <span class="identifier">interp_wrap</span><span class="special">(</span><span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">interpolated</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">).</span><span class="identifier">data</span><span class="special">(),</span><span class="identifier">N</span><span class="special">);</span>
        <span class="identifier">alpha_wrap</span> <span class="special">=</span> <span class="identifier">gamma</span><span class="special">.</span><span class="identifier">segment</span><span class="special">&lt;</span><span class="identifier">N</span><span class="special">&gt;(</span><span class="number">0</span><span class="special">);</span>

        <span class="identifier">vector_type</span> <span class="identifier">beta</span> <span class="special">=</span> <span class="identifier">vector_type</span><span class="special">::</span><span class="identifier">Constant</span><span class="special">(</span><span class="identifier">N</span><span class="special">,</span><span class="identifier">gamma</span><span class="special">[</span><span class="identifier">N</span><span class="special">]);</span>

        <span class="keyword">auto</span> <span class="identifier">K</span> <span class="special">=</span> <span class="identifier">create_dense_operator</span><span class="special">(</span><span class="identifier">knots</span><span class="special">,</span><span class="identifier">knots</span><span class="special">,</span><span class="identifier">kernel</span><span class="special">);</span>
        <span class="identifier">interp_wrap</span> <span class="special">=</span> <span class="identifier">K</span><span class="special">*</span><span class="identifier">alpha_wrap</span> <span class="special">+</span> <span class="identifier">beta</span><span class="special">;</span>

        <span class="keyword">double</span> <span class="identifier">rms_error</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
        <span class="keyword">double</span> <span class="identifier">scale</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
        <span class="keyword">for</span> <span class="special">(</span><span class="keyword">int</span> <span class="identifier">i</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">i</span><span class="special">&lt;</span><span class="identifier">N</span><span class="special">;</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">0</span><span class="special">];</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">position</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">])[</span><span class="number">1</span><span class="special">];</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">truth</span> <span class="special">=</span> <span class="identifier">funct</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span><span class="identifier">y</span><span class="special">);</span>
            <span class="keyword">const</span> <span class="keyword">double</span> <span class="identifier">eval_value</span> <span class="special">=</span> <span class="identifier">get</span><span class="special">&lt;</span><span class="identifier">interpolated</span><span class="special">&gt;(</span><span class="identifier">knots</span><span class="special">[</span><span class="identifier">i</span><span class="special">]);</span>
            <span class="identifier">rms_error</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">eval_value</span><span class="special">-</span><span class="identifier">truth</span><span class="special">,</span><span class="number">2</span><span class="special">);</span>
            <span class="identifier">scale</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pow</span><span class="special">(</span><span class="identifier">truth</span><span class="special">,</span><span class="number">2</span><span class="special">);</span>
            <span class="identifier">TS_ASSERT_DELTA</span><span class="special">(</span><span class="identifier">eval_value</span><span class="special">,</span><span class="identifier">truth</span><span class="special">,</span><span class="number">1e-2</span><span class="special">);</span>
        <span class="special">}</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"rms_error for global support, at centers  = "</span><span class="special">&lt;&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">rms_error</span><span class="special">/</span><span class="identifier">scale</span><span class="special">)&lt;&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="identifier">TS_ASSERT_LESS_THAN</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">sqrt</span><span class="special">(</span><span class="identifier">rms_error</span><span class="special">/</span><span class="identifier">scale</span><span class="special">),</span><span class="number">1e-3</span><span class="special">);</span>

<span class="special">}</span>
</pre>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2015-2017 Martin Robinson</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="symbolic_expressions.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="benchmarks.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
